<html>

<p><b>File format name:</b> Nikon ND2
<p><b>Maintainer:</b><a href="http://www.nikonusa.com">Nikon</a>
<p><b>Software that produces these files:</b><a href="http://www.nis-elements.com">NIS Elements</a>
<p><b>Other software that reads this format:</b>NIS Elements<BR>
<p><b>Specifications:</b>none :-(
<p><b>Structure:</b><BR>

** All ND2 files are little-endian.<BR><BR>

Old ND2:<BR><BR>

"Old" ND2 refers to files that were generated before May or June of 2007.
Basically, the file consists of a series of <a href="http://www.jpeg.org/jpeg2000/">JPEG-2000</a> codestreams, with a block of XML stuck on the end.<BR>

<BR>'file' on an old ND2 file looks like this:<BR><BR>

user@machine:/data/$ file old_nd2.nd2<BR>
old_nd2.nd2: JPEG 2000 image data<BR>

The first 8 bytes of the file should be: 0x00 00 00 0c 6a 50 20 20<BR><BR>

The only really noteworthy aspect of this format is that the XML block at the end of the file is malformed, so we have to parse it manually (meaning someone at some point may find missing or mislabeled metadata).

<BR><BR>New ND2:<BR><BR>

"New" ND2 refers to files that were generated after May or June of 2007.
The new format is much preferred to the old format, in that the pixels are stored raw (and thus JAI is not required).<BR>

<BR>'file' on a new ND2 file looks like this:<BR><BR>

user@machine:/data/$ file new_nd2.nd2<BR> 
new_nd2.nd2: PARIX object not stripped<BR>

The file is divided into chunks of the following format:<BR>

4 byte header - 0xda ce be 0a<BR>
4 bytes - signed integer (length part 1)<BR>
4 bytes - signed integer (length part 2)<BR>
4 bytes - signed integer (ignored)<BR>
length pt 1 + length pt 2 bytes of data<BR><BR>

The data portion of each chunk begins with a string identifer terminated by "!"; for pixel data, this is "ImageDataSeq|%n!", where %n is the plane number (indexed from 0).  Otherwise, if the identifier begins with "Image%s!", you can expect a block of XML metadata.  Unlike old ND2, this is valid XML, which we parse using SAX.
<BR><BR>

I have no idea how multiple channels are stored, since we have no multi-channel data.<BR>

<p><b>Other notes:</b><BR>
- JAI is required for reading old ND2 files<BR>
- We are aware that it takes too long to read image planes.  This has always been the case, and will continue to be until JAI is improved or we implement a native JPEG2000 solution.<BR>
- The axis size detection logic is absolutely horrible, but it works.<BR>
- We were first made aware of "new" ND2 in June 2007 - the precise date it was released is unknown.<BR>

</html>
